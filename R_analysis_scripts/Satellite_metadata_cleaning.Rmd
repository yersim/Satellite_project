---
title: "Satellite metadata cleaning"
author: "Simon Yersin"
date: "2024-02-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(readstata13)
library(stringr)
library(magrittr)
library(devtools)
library(tidyr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(writexl)
library(readxl)
library(gtsummary)
```

# Metadata table
```{r}
metadata <- read.dta13("/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Analysis/Metadata/afribiota_satellite_merged.dta", nonint.factors = TRUE)
# 782 columns

# Filtering to keep only satellite samples
metadata <- metadata %>%
  filter(projet == "Satellite")
# 44 samples
```

# Cleaning metadata
```{r}
md <- metadata
md <- md[, -c(657:782)]

# Removing vaccinations info:
md <- md[, -c(134:288)]

# Removing column 3 to 18: Only "OUI"
md <- md[,-c(3:18)]

# Changing sex labels:
levels(md$sexe) <- c("M", "F")

# Changing nutritional status labels:
levels(md$statut_nut) <- c("Normonutris", "Moderately malnutris", "Severely malnutris")
levels(md$etat_nut) <- c("No acute malnutrition", "Marasme", "Kwashiorkor", "Kwashiorkor-Marasmique", "Unspecified malnutrition")
levels(md$atcd_malnut) <- c("No", "Marasme", "Kwashiorkor", "Kwashiorkor-Marasmique", "Unspecified malnutrition", "Unknown")
levels(md$degre_malnut) <- c("Moderate", "Severe", "Unknown")
levels(md$haz) <- c("Normonutris", "Moderately chronic malnutris", "Severely chronic malnutris", "Moderatly too tall", "Severely too tall")

# Changing birth info labels:
levels(md$lieu_accou) <- c("Hospital", "Home with midwife", "Home with family", "Home alone", "Other", "I don't remember")
levels(md$taille_naiss_p) <- c("A lot smaller", "Smaller", "Same", "Bigger", "A lot bigger", "I don't know")
levels(md$voie_accou) <- c("Vaginal", "C-section")
levels(md$hemoglobine_seuil) <- c("Hemoglobine basse (<12 g/100ml)", "Hemoglobine normale (12 - 16 g/100ml)", "Hemoglobine haute (>16 g/100ml)")

#Remove columns that only contains NAs
md <- md[,names(md)[sapply(md, function(col) !all(is.na(col)))]]

# Redefine stunting level
# Severe stunting: HAZ < -3
# Moderate stunting: -3 <= HAZ < -2
# Mild stunting: -2 <= HAZ <= -1
# Normal growth: HAZ > -1
# Adding variable: Stunting_level
md <- md %>%
  mutate(Stunting_level = "")
md$Stunting_level[which(md$haz_cont < -3)] <- "Severe_stunting"
md$Stunting_level[which(md$haz_cont >= -3 & md$haz_cont < -2)] <- "Moderate_stunting"
md$Stunting_level[which(md$haz_cont >= -2 & md$haz_cont <= -1)] <- "Mild_stunting"
md$Stunting_level[which(md$haz_cont > -1)] <- "Normal_growth"
md$Stunting_level <- as.factor(md$Stunting_level)

# WHO definition: 
# Stunting: haz < -2
# Non-stunted: haz >= -2
md <- md %>%
  mutate(Stunting_status = "")
md$Stunting_status[which(md$haz_cont < -2)] <- "Stunted"
md$Stunting_status[which(md$haz_cont >= -2)] <- "Non_stunted"
md$Stunting_status <- as.factor(md$Stunting_status)

# Parasites
md <- md %>%
  mutate(Parasites = "")
md$Parasites[which(md$giardiase=="Oui" | md$entamoeba=="Oui" | md$parasite_aut=="Oui")] <- "Yes"
md$Parasites[which(md$giardiase=="Non" & md$entamoeba=="Non" & md$parasite_aut=="Non")] <- "No"
md$Parasites[which(md$Parasites=="")] <- NA
```

# Measurments
AAT, Calpro, Elastasem Bile acids
```{r}
AATdata <- read_excel("/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Documents/AATdata.xlsx")
AATdata <- AATdata[which(str_detect(AATdata$id, "AGN")),]
AATdata$id <- str_remove(AATdata$id, "-")
AATdata$`AAT  (mg/g)` <- as.numeric(AATdata$`AAT  (mg/g)`)
## 44 samples

elastaseData <- read_delim("/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Documents/elastase_data_872samples.csv", delim = ";", show_col_types = FALSE)
elastaseData <- elastaseData[which(str_detect(elastaseData$id, "AGN")),]
elastaseData$id <- str_replace_all(elastaseData$id, "AA", "A")
# 39 samples (5 missing)

inflamData <- read_excel("/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Documents/AFRIBIOTA_Kapelfinal_recodedv3.xlsx")
inflamData <- inflamData[which(str_detect(inflamData$id, "AGN")),]
inflamData$id <- str_remove(inflamData$id, "-")
# 44 samples
```

Marker in feces:
AAT - Alpha-1 Antitrypsin 
Elevated AAT levels indicate a protein leakage in the gut?
Normal range of AAT: below or equal 0.15 mg/g of fecal wet weight or 1.25 mg/g of fecal dry weight)

Calprotection:
Elevated levels indicate inflammation in the guts
Normal range: 
below 150 mg/g of fecal wet weight for children 2-3 years
below 100 mg/g of fecal wet weight for children above 3 years old


Elastase
Pancreatic function?
Cutoff?

Markers in blood:
C-reactive protein (CRP):
Systemic inflammation marker
haute (>10 mg/l)

Ferritin:
Low ferritin levels: <21.8 for male, <63 for female (values in ng/ml)
In biomarkers paper:
< 12 ug/L in the absence of inflammation
Factor 0.67 to adjust in case of inflammation

Hb - hemoglobine
basse (<12 g/100ml) = anemia

Marker in urine 
Mannitol-lactilol test as marker for leaky gut
T colum is the Mannitol/Lactilol ration *100 (for %)
Seuil >= 3.20 considered pathologic 


```{r}
# Adding AAT data to md
md <- merge(md, AATdata, by = "id")
md <- md %>%
  mutate(Gut_inflammation_AAT = "")
md$Gut_inflammation_AAT[which(md$`AAT  (mg/g)` > 0.15)] <- "Inflammation"
md$Gut_inflammation_AAT[which(md$`AAT  (mg/g)` <= 0.15)] <- "No_inflammation"

# Adding elastase data to md
md <- merge(md, elastaseData, by = "id", all.x = TRUE)

# Adding Calprotectin
md <- merge(md, inflamData, by = "id")
md <- md %>%
  mutate(Gut_inflammation_Calpro = "")
md$Gut_inflammation_Calpro[which(md$`CALPROTECTINE (μg/g)` >= 150 & md$nagem < 36)] <- "Inflammation"
md$Gut_inflammation_Calpro[which(md$`CALPROTECTINE (μg/g)` >= 100 &
                                   md$nagem >= 36 & md$nagem <= 59)] <- "Inflammation"
md$Gut_inflammation_Calpro[which(md$`CALPROTECTINE (μg/g)` >= 50 & md$nagem > 59)] <- "Inflammation"
md$Gut_inflammation_Calpro[which(md$`CALPROTECTINE (μg/g)` < 150 & md$nagem < 36)] <- "No_inflammation"
md$Gut_inflammation_Calpro[which(md$`CALPROTECTINE (μg/g)` < 100 &
                                   md$nagem >= 36 & md$nagem <= 59)] <- "No_inflammation"
md$Gut_inflammation_Calpro[which(md$`CALPROTECTINE (μg/g)` < 50 & md$nagem > 59)] <- "No_inflammation"

# Adding CRP data
md$crp <- str_replace_all(md$crp, "\\,", "\\.")
md <- md %>%
  mutate(Systemic_inflammation = "")
md$Systemic_inflammation[which(md$crp > 10)] <- "Systemic_inflammation"
md$Systemic_inflammation[which(md$crp <= 10)] <- "No_inflammation"

# Adding leaky gut
md <- md %>%
  mutate(Leaky_gut = "")
md$Leaky_gut[which(md$T >= 3.2)] <- "Leaky_gut"
md$Leaky_gut[which(md$T < 3.2)] <- "No_leaky_gut"
md$Leaky_gut[which(is.na(md$T))] <- NA
```

Bile acids data
```{r}
BAdata <- read_excel("/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Documents/Bileacidthirdround.xlsx")
BAdata <- BAdata[which(str_detect(BAdata$id, "AGN")),]
# 105 samples: duodenal, feces, gastric

# Adding sample type in sample name to merge with metadata below
BAdata <- BAdata %>%
  mutate(id_modif = id)
BAdata$id_modif <- str_replace(BAdata$id_modif, "1429AGN", "AGN")
BAdata$id_modif[which(BAdata$SampleType=="Feces")] <- str_c(BAdata$id_modif[which(BAdata$SampleType=="Feces")], "FE", sep = "")
BAdata$id_modif[which(BAdata$SampleType=="Duodenal")] <- str_c(BAdata$id_modif[which(BAdata$SampleType=="Duodenal")], "DU", sep = "")
BAdata$id_modif[which(BAdata$SampleType=="Gastric")] <- str_c(BAdata$id_modif[which(BAdata$SampleType=="Gastric")], "GA", sep = "")
```

# Summary table 
```{r}
md_sum <- md %>% select(id, Stunting_status, nagem, sexe, voie_accou, Gut_inflammation_AAT, Gut_inflammation_Calpro,
                        Systemic_inflammation, Leaky_gut, nagem)

md_sum$Stunting_status <- str_replace_all(md_sum$Stunting_status, "_", " ")

md_sum$sexe <- str_replace_all(md_sum$sexe, "M", "Male")
md_sum$sexe <- str_replace_all(md_sum$sexe, "F", "Female")

md_sum$Gut_inflammation_AAT[which(md_sum$Gut_inflammation_AAT=="No_inflammation")] <- "No inflammation"
md_sum$Gut_inflammation_Calpro[which(md_sum$Gut_inflammation_Calpro=="No_inflammation")] <- "No inflammation"

md_sum <- md_sum %>%
  mutate(Age_group = case_when(
    nagem >= 24 & nagem < 36 ~ "2-3 years old",
    nagem >= 36 & nagem < 48 ~ "3-4 years old",
    nagem >= 48 & nagem < 60 ~ "4-5 years old",
    nagem >= 60 ~ "5 years old")
  )


sample_sum <- read_xlsx("/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Sample_summary.xlsx",
                        skip = 1)
sample_sum <- sample_sum[-c(45:47),1:5]
colnames(sample_sum)[2] <- "Saliva"
colnames(sample_sum)[3] <- "Gastric aspirate"
colnames(sample_sum)[4] <- "Duodenal aspirate"
colnames(sample_sum)[5] <- "Stool"
sample_sum$Stool[which(sample_sum$Stool=="x")] <- "Y"
sample_sum$`Duodenal aspirate`[which(sample_sum$ID=="1429AGN043")] <- "N"


md_sum <- merge(md_sum, sample_sum, by.x = "id", by.y = "ID")


md_sum %>% 
  select(Stunting_status, nagem, Age_group, sexe, voie_accou,Gut_inflammation_AAT,
         Gut_inflammation_Calpro) %>%
  tbl_summary(by = Stunting_status,
              missing = "no",
              label = c(nagem ~ "Age [months]",
                        Age_group ~ "Age group",
                        sexe ~ "Sex",
                        voie_accou ~ "Delivery mode",
                        Gut_inflammation_AAT ~ "Alpha1-antitrypsin",
                        Gut_inflammation_Calpro ~ "Calprotectin")) %>%
  modify_header(label = "**Variable**") %>%
  add_overall() %>%
  as_gt() %>%
  gt::gtsave(filename = "/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Analysis/Metadata/table_md_summary.docx")

```



# Metadata for analysis
```{r}
# Creating 4 md tables as each individual has potentially 4 samples with the same ID
# Saliva
md_s <- md %>%
  mutate(body_site = "Saliva") %>%
  mutate(id_modif = id)
md_s$id_modif <- str_replace(md_s$id_modif, "1429AGN", "AGN")
md_s$id_modif <- str_c(md_s$id_modif, "SA", sep = "")
md_s <- as.data.frame(md_s)
rownames(md_s) <- md_s$id_modif
# Gastric
md_g <- md %>%
  mutate(body_site = "Gastric") %>%
  mutate(id_modif = id)
md_g$id_modif <- str_replace(md_g$id_modif, "1429AGN", "AGN")
md_g$id_modif <- str_c(md_g$id_modif, "GA", sep = "")
md_g <- as.data.frame(md_g)
rownames(md_g) <- md_g$id_modif
# Duodenal
md_d <- md %>%
  mutate(body_site = "Duodenum") %>%
  mutate(id_modif = id)
md_d$id_modif <- str_replace(md_d$id_modif, "1429AGN", "AGN")
md_d$id_modif <- str_c(md_d$id_modif, "DU", sep = "")
md_d <- as.data.frame(md_d)
rownames(md_d) <- md_d$id_modif
# Feces
md_f <- md %>%
  mutate(body_site = "Feces") %>%
  mutate(id_modif = id)
md_f$id_modif <- str_replace(md_f$id_modif, "1429AGN", "AGN")
md_f$id_modif <- str_c(md_f$id_modif, "FE", sep = "")
md_f <- as.data.frame(md_f)
rownames(md_f) <- md_f$id_modif

md_sat <- rbind(md_s, md_g, md_d, md_f)

md_sat <- merge(md_sat, BAdata, by="id_modif", all.x = TRUE)
colnames(md_sat)[2] <- "id"
```

Add sequencing depth information host read removal 
```{r}
seq_metag <- as.data.frame(read_delim("/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Analysis/Metadata/bowtie_summary.tsv",
                                      delim = "\t", show_col_types = FALSE))

seq_metag <- seq_metag %>% filter(SampleName != "AGN043DU")

seq_metag <- seq_metag %>%
  mutate(SeqBatch = case_when(
    str_detect(seq_metag$SampleName, "SE") ~ "VH",
    TRUE ~ "SY"
  ))

seq_metag$SampleName <- str_replace(seq_metag$SampleName, "SE_AGN_", "AGN")
seq_metag$SampleName[110:128] <- str_c(seq_metag$SampleName[110:128], "FE")

seq_metag_bs <- seq_metag %>%
  mutate(body_site = case_when(
    str_detect(SampleName, "SA") ~ "Saliva",
    str_detect(SampleName, "GA") ~ "Gastric",
    str_detect(SampleName, "DU") ~ "Duodenal",
    str_detect(SampleName, "FE") ~ "Stool"
  ))
# Fixing duplication total for AGN006FE for stats
seq_metag_bs$Total[which(seq_metag_bs$SampleName=="AGN006FE")] <- seq_metag_bs$Total[which(seq_metag_bs$SampleName=="AGN006FE")]/2
seq_metag_bs$Retained[which(seq_metag_bs$SampleName=="AGN006FE")] <- seq_metag_bs$Retained[which(seq_metag_bs$SampleName=="AGN006FE")]/2
seq_metag_bs$Removed[which(seq_metag_bs$SampleName=="AGN006FE")] <- seq_metag_bs$Removed[which(seq_metag_bs$SampleName=="AGN006FE")]/2

seq_df <- seq_metag_bs %>%
  dplyr::group_by(SeqBatch, body_site) %>%
  summarise(Samples = n_distinct(SampleName),
            mean = mean(Retained),
            max = max(Retained),
            min = min(Retained),
            sd = sd(Retained),
            sum = sum(Retained),
            mean_removed = mean(Removed))

# Save table with sequencing info after filtering
write.csv(seq_df, "/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Analysis/Metadata/MetaG_Satellite_sequencing_info.csv")
md_sat <- merge(md_sat, seq_metag, by.x = "id_modif", by.y="SampleName", all.x = TRUE)
```


id = general sample ID (1429AGN###)
sexe = sex of the individual
nagem = age in months 
nheight = height of the individual
nweight = weight of the individual
statut_nut = nutritional status at recruitment (different than HAZ)
voie_accou = delivery (vaginal or C-section)
atb_suivi = antibiotic (yes or no)
ph_estomac
ph_intestin
crp = C-reactive protein
SeqBatch = sequencing batch (either VH or SY)

Save dataset
```{r}
write_xlsx(md_sat, "/Users/admin/Documents/VLab_projects/01_Projects_MAIN/Satellite/Analysis/Metadata/Metadata_satellite_full.xlsx")
```

Metadata_satellite.xlsx = 1 row per sample (only 44 rows)
Metadata_satellite_full.xlsx = 4 rows per samples (each row is a samples type: saliva, gastric, duodenal, feces) --> Used for analysis

No need:
# Correlation inflammation - seqdepth
```{r}
md_sat_fe <- filter(md_sat, body_site=="Feces")

md_sat_fe <- dplyr::select(md_sat_fe, c("id_modif", "stunted", "sexe", "nagem", "nweight", "statut_nut", "Gut_inflammation_Calpro",
                                        "SeqBatch",
                                 "Gut_inflammation_AAT", "Systemic_inflammation", "Leaky_gut", "Total", "Retained", "Removed",
                                 "Retained%", "CALPROTECTINE (μg/g)", "AAT  (mg/g)", "crp", "voie_accou", "atb_suivi"))
# Seq depth of samples seq a Novogene by SY
md_sat_fe %>% filter(SeqBatch == "SY") %>%
  summarise(mean = mean(Total)) # Seq depth of samples seq at Novogene: 44619690 reads
md_sat_fe %>% filter(SeqBatch == "VH") %>%
  filter(id_modif != "AGN006FE") %>%
  summarise(mean = mean(Total)) # 110199076 --> 0.4049008
md_sat_fe %>% filter(SeqBatch == "VH") %>%
  filter(id_modif == "AGN006FE") %>%
  summarise(mean = mean(Total)) # 233311614 --> 0.191245
# Subsample the sequencing depth
# SY batch 0.4049008 of VH batch
md_fe_sub <- md_sat_fe
md_fe_sub$`Retained%` <- str_remove_all(md_fe_sub$`Retained%`, "%")
md_fe_sub$`Retained%` <- as.numeric(md_fe_sub$`Retained%`)/100

md_fe_sub <- md_fe_sub %>%
  mutate(Removed_per = Removed/Total)
md_fe_sub <- md_fe_sub %>%
  mutate(Retained_per = Retained/Total)

md_fe_sub <- md_fe_sub %>%
  mutate(Ratio_RetRem = Removed/Retained)

# Calpro
ggplot(md_fe_sub, aes(x = Removed_per, y = `CALPROTECTINE (μg/g)`, color = Gut_inflammation_Calpro)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(title = paste("Correlation:", round(cor.test(md_fe_sub$Removed_per, md_fe_sub$`CALPROTECTINE (μg/g)`, method = "pearson")$estimate, 2)))

#AAT
ggplot(md_fe_sub, aes(x = Removed_per, y = as.numeric(`AAT  (mg/g)`), color = Gut_inflammation_AAT)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(title = paste("Correlation:", round(cor.test(md_fe_sub$Removed_per, as.numeric(md_fe_sub$`AAT  (mg/g)`), method = "pearson")$estimate, 2)))


# CRP
ggplot(md_fe_sub, aes(x = Removed_per, y = as.numeric(md_fe_sub$crp), color = Systemic_inflammation)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(title = paste("Correlation:", round(cor.test(md_fe_sub$Removed_per, as.numeric(md_fe_sub$crp), method = "pearson")$estimate, 2)))
```

```{r}
# testing linear models with multiviate
summary(lm(Removed_per ~ `AAT  (mg/g)` + nagem + stunted + voie_accou + atb_suivi, data = md_fe_sub))
summary(lm(Removed_per ~ `CALPROTECTINE (μg/g)` + stunted + nagem + voie_accou + atb_suivi, data = md_fe_sub))
summary(lm(Removed_per ~ as.numeric(md_fe_sub$crp) + nagem + stunted + voie_accou + atb_suivi, data = md_fe_sub))

# Using categorical variable instead
summary(lm(Removed_per ~ Gut_inflammation_AAT + nagem + stunted + voie_accou + atb_suivi, data = md_fe_sub))
summary(lm(Removed_per ~ Gut_inflammation_Calpro + stunted + nagem + voie_accou + atb_suivi, data = md_fe_sub))
summary(lm(Removed_per ~ Systemic_inflammation + nagem + stunted + voie_accou + atb_suivi, data = md_fe_sub))
# CRP significative? Outlier: AGN001FE
# TEst oulier
# Fit the model
model <- lm(Retained_per ~ `CALPROTECTINE (μg/g)` + stunted + nagem, data = md_fe_sub)
# Influence metrics
library(car)
influence.measures(model)
# Cook distance > 0.5 or 1
# Yes for AGN001 --> remove it
```


Removing outliers?
```{r}
md_fe_noout <- md_fe_sub %>% filter(id_modif != "AGN001FE")
# Reetesting without AGN001
summary(lm(Removed_per ~ `AAT  (mg/g)` + nagem + stunted, data = md_fe_noout))
summary(lm(Removed_per ~ `CALPROTECTINE (μg/g)` + stunted + nagem, data = md_fe_noout))
summary(lm(Removed_per ~ as.numeric(md_fe_noout$crp) + nagem + stunted, data = md_fe_noout))
# CRP not signifcative anymore but Calpro is
# Another outlier?
ggplot(md_fe_noout, aes(x = Removed_per, y = `CALPROTECTINE (μg/g)`, color = Gut_inflammation_Calpro)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(title = paste("Correlation:", round(cor.test(md_fe_noout$Removed_per, md_fe_noout$`CALPROTECTINE (μg/g)`, method = "pearson")$estimate, 2)))
# Potential outlier of AGN041, test with Cook distance:
model <- lm(Retained_per ~ `CALPROTECTINE (μg/g)` + stunted + nagem, data = md_fe_noout)
influence.measures(model)
cooks <- cooks.distance(model)
plot(cooks, type = "h", main = "Cook's Distance", ylab = "Cook's D")
abline(h = 1, col = "red", lty = 2)
# 1.8 for AGN041 --> outlier to be removed
md_fe_noout <- md_fe_noout %>% filter(id_modif != "AGN041FE")
# Retesting without two outliers
summary(lm(Removed_per ~ `AAT  (mg/g)` + nagem + stunted, data = md_fe_noout))
summary(lm(Removed_per ~ `CALPROTECTINE (μg/g)` + stunted + nagem, data = md_fe_noout))
summary(lm(Removed_per ~ as.numeric(md_fe_noout$crp) + nagem + stunted, data = md_fe_noout))

summary(lm(Removed_per ~ Gut_inflammation_AAT + nagem + stunted, data = md_fe_noout))
summary(lm(Removed_per ~ Gut_inflammation_Calpro + stunted + nagem, data = md_fe_noout))
summary(lm(Removed_per ~ Systemic_inflammation + nagem + stunted, data = md_fe_noout))

```
"We found a significant association between calprotectin and the proportion of retained non-human reads (p = ...), but this was no longer significant after removing two highly influential samples (AGN001FE and AGN041FE, Cook’s D > 1)."

Testing with robust lm: 
```{r}
colnames(md_fe_sub)[16] <- "Calpro"
colnames(md_fe_sub)[17] <- "AAT"

library(MASS)
# Robust model for Removed_per with AAT
robust_aat <- rlm(Removed_per ~ AAT + nagem + stunted ++ voie_accou + atb_suivi, data = md_fe_sub)
summary(robust_aat)

# Robust model for Removed_per with Calprotectin
robust_calpro <- rlm(Removed_per ~ Calpro + stunted + nagem + voie_accou + atb_suivi, data = md_fe_sub)
summary(robust_calpro)

# Robust model for Removed_per with CRP
robust_crp <- rlm(Removed_per ~ as.numeric(crp) + nagem + stunted + voie_accou + atb_suivi, data = md_fe_sub)
summary(robust_crp)
# Nothing is siginficant so most likely the lm were drivent by these two outliers 
```


```{r}
# Histogram of AAT
ggplot(md_fe_sub, aes(x = as.numeric(`AAT  (mg/g)`))) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white") +
  labs(title = "Histogram of AAT (mg/g)", x = "AAT (mg/g)", y = "Count") +
  theme_minimal()

# Histogram of Calprotectin
ggplot(md_fe_sub, aes(x = as.numeric(`CALPROTECTINE (μg/g)`))) +
  geom_histogram(binwidth = 50, fill = "darkgreen", color = "white") +
  labs(title = "Histogram of Calprotectin (μg/g)", x = "Calprotectin (μg/g)", y = "Count") +
  theme_minimal()

# Histogram of CRP
ggplot(md_fe_sub, aes(x = as.numeric(crp))) +
  geom_histogram(binwidth = 10, fill = "tomato", color = "white") +
  labs(title = "Histogram of CRP", x = "CRP", y = "Count") +
  theme_minimal()
```


Testing with log transform for the inflammation markers
```{r}
# Log-transform markers
md_fe_sub$log_aat <- log1p(as.numeric(md_fe_sub$AAT))
md_fe_sub$log_calpro <- log1p(as.numeric(md_fe_sub$Calpro))
md_fe_sub$log_crp <- log1p(as.numeric(md_fe_sub$crp))

# lm
# AAT
model_lm_aat <- lm(Removed_per ~ log_aat + nagem + stunted, data = md_fe_sub)
summary(model_lm_aat)
# Calprotectin
model_lm_calpro <- lm(Removed_per ~ log_calpro + nagem + stunted, data = md_fe_sub)
summary(model_lm_calpro)
plot(model_lm_calpro, which = 1)
plot(model_lm_calpro, which = 2)
# CRP
model_lm_crp <- lm(Removed_per ~ log_crp + nagem + stunted, data = md_fe_sub)
summary(model_lm_crp)
plot(model_lm_crp, which = 1)
plot(model_lm_crp, which = 2)
# rlm
model_rlm_aat <- rlm(Removed_per ~ log_aat + nagem + stunted, data = md_fe_sub)
summary(model_rlm_aat)

model_rlm_calpro <- rlm(Removed_per ~ log_calpro + nagem + stunted, data = md_fe_sub)
summary(model_rlm_calpro)

model_rlm_crp <- rlm(Removed_per ~ log_crp + nagem + stunted, data = md_fe_sub)
summary(model_rlm_crp)
# None are significant again
```












